{
"Fn::Base64": {
"Fn::Join": [ "", [
        "    - name: preamble\n",
        "      command: start\n",
        "      content: |\n",
        "        #cloud-config\n",
        "        ---\n",
        "        coreos:\n",
        "          etcd:\n",
        "            discovery: ", {"Ref": "DiscoveryURL"}, "\n",
        "            addr: $private_ipv4:4001\n",
        "            peer-addr: $private_ipv4:7001\n",
        "          fleet:\n",
        "            public-ip: $private_ipv4\n",
        "            metadata: consul_role=server\n",
        "          flannel:\n",
        "            interface: $private_ipv4\n",
        "    - name: consul-http-router.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=consul-http-router\n",
        "        PartOf=consul-server.service\n",
        "        After=consul-server.service\n",
        "        [Service]\n",
        "        Restart=always\n",
        "        RestartSec=10\n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStartPre=-/usr/bin/docker kill %p\n",
        "        ExecStartPre=-/usr/bin/docker rm %p\n",
        "        ExecStartPre=-/usr/bin/docker pull cargonauts/consul-http-router\n",
        "        ExecStart=/bin/sh -c \"exec /usr/bin/docker run \\\n",
        "          --rm --name consul-http-router \\\n",
        "          -p :80:80 \\\n",
        "          --dns $(ifconfig docker0 | grep 'inet ' | awk '{print $2}') \\\n",
        "          --dns-search=service.consul \\\n",
        "          cargonauts/consul-http-router\"\n",
        "        ExecStop=/usr/bin/docker stop %p\n",
        "        SyslogIdentifier=%p\n",
        "        SuccessExitStatus=11 12\n",
        "        [X-Fleet]\n",
        "        MachineMetadata=consul_role=server\n",
        "    - name: consul-server-announcer.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=Consul Server Announcer\n",
        "        PartOf=consul-server.service\n",
        "        After=consul-server.service\n",
        "        \n",
        "        [Service]\n",
        "        Restart=always\n",
        "        RestartSec=30\n",
        "        \n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStart=/bin/sh -c \"while true; do \\\n",
        "          etcdctl set /consul/bootstrap/machines/$(cat /etc/machine-id) $COREOS_PRIVATE_IPV4 --ttl 60;\\\n",
        "          /usr/bin/docker exec consul-server consul join $(etcdctl get $(etcdctl ls /consul/bootstrap/machines | tail -1)); sleep 45;\\\n",
        "         done\"\n",
        "        ExecStop=/bin/sh -c \"/usr/bin/etcdctl rm /consul/bootstrap/machines/$(cat /etc/machine-id)\"\n",
        "        SyslogIdentifier=%p\n",
        "        \n",
        "        [X-Fleet]\n",
        "        MachineMetadata=consul_role=server\n",
        "    - name: consul-server-registrator.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=Registrator\n",
        "        PartOf=consul-server.service\n",
        "        After=consul-server.service\n",
        "        \n",
        "        [Service]\n",
        "        Restart=always\n",
        "        RestartSec=60\n",
        "        TimeoutStartSec=3m\n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStartPre=-/usr/bin/docker kill %p\n",
        "        ExecStartPre=-/usr/bin/docker rm %p\n",
        "        ExecStartPre=/usr/bin/docker pull progrium/registrator\n",
        "        ExecStart=/bin/sh -c \"exec /usr/bin/docker run \\\n",
        "          --name %p \\\n",
        "          -h registrator \\\n",
        "          -v /var/run/docker.sock:/tmp/docker.sock \\\n",
        "           progrium/registrator \\\n",
        "           consul://$COREOS_PRIVATE_IPV4:8500 \\\n",
        "           -resync 60\"\n",
        "        ExecStop=/usr/bin/docker stop %p\n",
        "        SyslogIdentifier=%p\n",
        "        SuccessExitStatus=2\n",
        "        \n",
        "        [X-Fleet]\n",
        "        MachineMetadata=consul_role=server\n",
        "    - name: consul-server.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=Consul Server Agent\n",
        "        After=docker.service\n",
        "        After=etcd.service\n",
        "        \n",
        "        [Service]\n",
        "        Restart=always\n",
        "        RestartSec=60\n",
        "        TimeoutStartSec=3m\n",
        "        \n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStartPre=-/usr/bin/docker kill %p\n",
        "        ExecStartPre=-/usr/bin/docker rm %p\n",
        "        ExecStartPre=/usr/bin/docker pull cargonauts/progrium-consul\n",
        "        ExecStart=/bin/sh -c \"exec /usr/bin/docker run \\\n",
        "          --name %p \\\n",
        "          -h %H \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8300:8300 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8301:8301 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8301:8301/udp \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8302:8302 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8302:8302/udp \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8400:8400 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8500:8500 \\\n",
        "          -p $(ifconfig docker0 | grep 'inet ' | awk '{print $2}'):53:53 \\\n",
        "          -p $(ifconfig docker0 | grep 'inet ' | awk '{print $2}'):53:53/udp \\\n",
        "          -e SERVICE_IGNORE=true \\\n",
        "          -v /var/run/docker.sock:/var/run/docker.sock \\\n",
        "          cargonauts/progrium-consul \\\n",
        "          -server \\\n",
        "          -advertise $COREOS_PRIVATE_IPV4 \\\n",
        "          $(awk '/^nameserver/{print \\\" -recursor \\\" $2}' /etc/resolv.conf) \\\n",
        "          -bootstrap-expect 3\"\n",
        "        \n",
        "        ExecStop=/usr/bin/docker exec consul-server kill -INT 1\n",
        "        SyslogIdentifier=%p\n",
        "        SuccesExitStatus=1\n",
        "        \n",
        "        [X-Fleet]\n",
        "        X-ConditionMachineMetadata=consul_role=server\n",
"" ]]}}
