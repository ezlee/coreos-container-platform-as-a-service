{
"Fn::Base64": {
"Fn::Join": [ "", [
        "#cloud-config\n",
        "---\n",
        "write-files:\n",
        "- path: /etc/conf.d/nfs\n",
        "  permissions: '0644'\n",
        "  content: |\n",
        "    OPTS_RPC_MOUNTD=\"\"\n",
        "coreos:\n",
        "  etcd:\n",
        "    discovery: ", {"Ref": "DiscoveryURL"}, "\n",
        "    addr: $private_ipv4:4001\n",
        "    peer-addr: $private_ipv4:7001\n",
        "  fleet:\n",
        "    public-ip: $private_ipv4\n",
        "    metadata: consul_role=server\n",
        "  flannel:\n",
        "    interface: $private_ipv4\n",
        "  units:\n",
        "    - name: etcd.service\n",
        "      command: start\n",
        "    - name: fleet.service\n",
        "      command: start\n",
        "    - name: rpc-statd.service\n",
        "      command: start\n",
        "    - name: consul-http-router.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=consul-http-router\n",
        "        After=consul-server.service\n",
        "        [Service]\n",
        "        Restart=always\n",
        "        \n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStartPre=-/usr/bin/docker kill %p\n",
        "        ExecStartPre=-/usr/bin/docker rm %p\n",
        "        ExecStartPre=-/usr/bin/docker pull cargonauts/consul-http-router\n",
        "        ExecStart=/bin/sh -c \"exec /usr/bin/docker run \\\n",
        "          --rm --name consul-http-router \\\n",
        "          -p :80:80 \\\n",
        "          --dns $(ifconfig docker0 | grep 'inet ' | awk '{print $2}') \\\n",
        "          --dns-search=service.consul \\\n",
        "          cargonauts/consul-http-router\"\n",
        "        ExecStop=/usr/bin/docker stop %p\n",
        "        SyslogIdentifier=%p\n",
        "        SuccessExitStatus=11 12\n",
        "        [X-Fleet]\n",
        "        MachineMetadata=consul_role=server\n",
        "    - name: consul-server-registrator.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=Registrator\n",
        "        After=consul-server.service\n",
        "        \n",
        "        [Service]\n",
        "        Restart=always\n",
        "        TimeoutStartSec=3m\n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStartPre=-/usr/bin/docker kill %p\n",
        "        ExecStartPre=-/usr/bin/docker rm %p\n",
        "        ExecStartPre=/bin/sh -c \"/usr/bin/docker history gliderlabs/registrator:v6 || \\\n",
        "           /usr/bin/docker pull gliderlabs/registrator:v6\"\n",
        "        \n",
        "        ExecStart=/bin/sh -c \"exec /usr/bin/docker run \\\n",
        "          -v /var/run/docker.sock:/tmp/docker.sock \\\n",
        "           gliderlabs/registrator:v6 \\\n",
        "           -ip $COREOS_PRIVATE_IPV4 \\\n",
        "           -resync 60 \\\n",
        "           consul://$COREOS_PRIVATE_IPV4:8500\"\n",
        "        ExecStop=/usr/bin/docker stop %p\n",
        "        SyslogIdentifier=%p\n",
        "        SuccessExitStatus=2\n",
        "        \n",
        "        [X-Fleet]\n",
        "        MachineMetadata=consul_role=server\n",
        "    - name: consul-server.service\n",
        "      command: start\n",
        "      content: |\n",
        "        [Unit]\n",
        "        Description=Consul Server Agent\n",
        "        After=docker.service\n",
        "        After=etcd.service\n",
        "        \n",
        "        [Service]\n",
        "        Restart=always\n",
        "        TimeoutStartSec=180\n",
        "        \n",
        "        EnvironmentFile=/etc/environment\n",
        "        ExecStartPre=-/usr/bin/docker kill %p\n",
        "        ExecStartPre=-/usr/bin/docker rm %p\n",
        "        \n",
        "        ExecStartPre=/bin/sh -c \\\n",
        "            \"docker history cargonauts/progrium-consul >/dev/null || \\\n",
        "            docker pull cargonauts/progrium-consul\"\n",
        "        \n",
        "        ExecStart=/bin/sh -c \"exec /usr/bin/docker run \\\n",
        "          --name %p \\\n",
        "          -h %H \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8300:8300 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8301:8301 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8301:8301/udp \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8302:8302 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8302:8302/udp \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8400:8400 \\\n",
        "          -p $COREOS_PRIVATE_IPV4:8500:8500 \\\n",
        "          -p $(ifconfig docker0 | grep 'inet ' | awk '{print $2}'):53:53 \\\n",
        "          -p $(ifconfig docker0 | grep 'inet ' | awk '{print $2}'):53:53/udp \\\n",
        "          -e SERVICE_8500_NAME=consul-ui \\\n",
        "          -e SERVICE_8500_TAGS=http \\\n",
        "          -v /var/run/docker.sock:/var/run/docker.sock \\\n",
        "          cargonauts/progrium-consul \\\n",
        "          -server \\\n",
        "          -advertise $COREOS_PRIVATE_IPV4 \\\n",
        "          $(awk '/^nameserver/{print \\\" -recursor \\\" $2}' /etc/resolv.conf) \\\n",
        "          $(fleetctl list-machines | awk '/consul_role=server/{print \\\"-join \\\" $2}') \\\n",
        "          -bootstrap-expect 3\"\n",
        "        \n",
        "        ExecStop=/usr/bin/docker stop %p\n",
        "        SyslogIdentifier=%p\n",
        "        SuccessExitStatus=1\n",
        "        \n",
        "        [X-Fleet]\n",
        "        X-ConditionMachineMetadata=consul_role=server\n",
"" ]]}}
